<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller=function($scope,$rootScope,$timeout,spUtil) {
  /* widget controller */
  var c = this;

  c.emitMyChargingSession = function(){
	console.log('getting and emitting charge session')
	if(c.data.charge_session && c.data.charge_session !=''){
		console.log(c.data.charge_session);
		$rootScope.$emit('my_charging_session',c.data.charge_session);
		console.log('emitted!');
	} else {
		// $timeout(function(){
		// 	c.emitMyChargingSession();
		// },4000);
	}
  };

  c.liveUpdate = function(){
	console.log('Updating my session live');
	spUtil.recordWatch($scope, c.data.constants.TABLE_CHARGERS, c.data.charger_filter, function(record){
		spUtil.update($scope).then(function(){

		});
	});
	spUtil.recordWatch($scope, c.data.constants.TABLE_QUEUE, c.data.queue_filter, function(record) {
		//console.log([c.data.filter,name]);
		spUtil.update($scope).then(function(){

		});
	});
  }

  

  $timeout(function(){
	//c.emitMyChargingSession();
	c.liveUpdate();
  });

  $scope.$watch('data.charge_session',function(){
	c.emitMyChargingSession();
  });
  


};]]></client_script>
        <controller_as>c</controller_as>
        <css/>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>charger-my-charging-session</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>My Charging Session</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
  /* populate the 'data' object */
  /* e.g., data.table = $sp.getValue('table'); */
  var cu = new ChargerUtils();
  data.constants = cu.getConstants();
  const {TABLE_CHARGERS,TABLE_QUEUE} = data.constants;
  var me = gs.getUserID();
  //data.filter = 'requested_by='+me+'^state=in_progress';
  data.queue_filter = 'active=true^requested_by='+me+'^requested_onONToday@javascript:gs.beginningOfToday()@javascript:gs.endOfToday()^state!=requested';
  //var charger = new GlideRecord(TABLE_CHARGERS);
  var chargeSession = cu.getChargeSession(data.queue_filter);
  data.charge_session = chargeSession;
  if(chargeSession){
	data.charger_filter = 'sys_id='+chargeSession.charger;
  	//var charger = cu.getChargerIDByUser(me,'in_progress').charger;
	data.widget = $sp.getWidget("charger-card",{charger_id:chargeSession.charger});
  }
  
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>aaron.brunet</sys_created_by>
        <sys_created_on>2024-03-14 00:50:40</sys_created_on>
        <sys_id>084027ab87bc4a106e4b11f83cbb35e8</sys_id>
        <sys_mod_count>31</sys_mod_count>
        <sys_name>My Charging Session</sys_name>
        <sys_package display_value="Charger" source="x_snc_charger">7a4ce69387e04a106e4b11f83cbb3517</sys_package>
        <sys_policy/>
        <sys_scope display_value="Charger">7a4ce69387e04a106e4b11f83cbb3517</sys_scope>
        <sys_update_name>sp_widget_084027ab87bc4a106e4b11f83cbb35e8</sys_update_name>
        <sys_updated_by>aaron.brunet</sys_updated_by>
        <sys_updated_on>2024-03-14 03:20:15</sys_updated_on>
        <template><![CDATA[<div ng-if="data.charge_session">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <div>
    <h2>Current Charge Session</h2>
    <sp-widget widget="data.widget"></sp-widget>
    <button class="btn btn-option charge-button">Complete Session</button>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
