<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller=function($scope,spUtil,$rootScope,spModal) {
  /* widget controller */
  var c = this;

	c.action = function(action) {
		if(action == 'join'){
			var cat_item = c.data.constants.CAT_ITEM_JOIN_QUEUE;			
		}
		if(action == 'update'){
			var cat_item = c.data.constants.CAT_ITEM_UPDATE_SESSION;
			var passed_data = {
				values:
				[
					{
						fieldName:'vehicle',
						fieldValue:c.data.charge_session.details.vehicle.value,
						enforced:false
					}
				]
			};
			if(!c.data.charge_session.details.request_preference){
				passed_data.values.push({
					fieldName:'request_preference',
					fieldValue:'first_available',
					enforced:false
				});
			} else {
				passed_data.values.push({
					fieldName:'request_preference',
					fieldValue:'specific_charger',
					enforced:false
				});
				passed_data.values.push({
					fieldName:'charger',
					fieldValue:c.data.charge_session.details.request_preference.value,
					enforced:false
				});
			}
		}
		spModal.open({
			"widget" : "sc-input-wrapper",
			"widgetInput" : {
				sys_id: cat_item,
				"display_cart_on_right": "false",
				"auto_redirect": false,
				passed_fields: passed_data,
				embedded: true
			},
			"buttons":[],
		});

  };

  $rootScope.$on('my_charging_session',function(event,parms){
	//console.log(['Charger Queue $on',event,parms]);
	c.data.charge_session = parms;//{sys_id:parms.charger,state:parms.details.state};
	c.data.charge_session_exists = (parms.charger && parms.charger !== '');
	console.log(['Charger Queue',c.data.charge_session,c.data.charge_session_exists]);
  });

  spUtil.recordWatch($scope, c.data.constants.TABLE_CHARGERS, 'state=available', function(name) {
		//console.log([name]);
		spUtil.update($scope).then(function(){
		// 	// $scope.server.update().then(function(){
		});
	});
	spUtil.recordWatch($scope, c.data.constants.TABLE_QUEUE, 'requested_by='+c.data.me, function(name) {
		//console.log([name]);
		spUtil.update($scope).then(function(){
		// 	// $scope.server.update().then(function(){
		});
	});
};]]></client_script>
        <controller_as>c</controller_as>
        <css>.charge-queue-container {&#13;
  /*border: 1px solid grey;*/&#13;
      box-shadow: 0 0.2rem 1rem 0 rgba(0, 0, 0, .1);&#13;
&#13;
  border-radius: 2rem;&#13;
  display: flex;&#13;
  padding: 2rem;&#13;
  margin: 2rem;&#13;
}&#13;
&#13;
.charge-queue-title, .charge-queue-details {&#13;
	align-items: center;&#13;
  	justify-content: center;&#13;
  	text-align: center;&#13;
}&#13;
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>charger-queue</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>Charger Queue</name>
        <option_schema/>
        <public>false</public>
        <roles>x_snc_charger.user</roles>
        <script><![CDATA[(function() {
  /* populate the 'data' object */
  /* e.g., data.table = $sp.getValue('table'); */
	var cu = new ChargerUtils();
	data.constants = cu.getConstants();
	const {TABLE_CHARGERS,TABLE_QUEUE} = data.constants;

	var me = gs.getUserID();
	data.me = me;

	data.available_chargers = false;
	data.my_request = false;
	data.queue = [];
	
	var chargers = new GlideRecord(TABLE_CHARGERS);
	chargers.addQuery('state','available');
	chargers.query();
	if(chargers.hasNext()){
		data.available_chargers = true;
		data.available_chargers_count = chargers.getRowCount();
	} 
		var queue = new GlideRecord(TABLE_QUEUE);
		queue.addEncodedQuery('active=true^state=requested^requested_onONToday@javascript:gs.beginningOfToday()@javascript:gs.endOfToday()');
		queue.orderBy('requested_on');
		queue.query();
		data.queue_length = queue.getRowCount();
		while(queue.next()){
			data.queue.push({sys_id:queue.getUniqueValue(),requested_by:queue.getValue('requested_by')});
			if(queue.getValue('requested_by') == me){
				data.my_request = true;
			}
		}

	var _options = {
		filter:'available',
		embedded:true,
		show_filter_buttons:false,
		live_update:false,
		click_action:'new_session'
	};
	data.widget = $sp.getWidget("charger-card-list",_options);
	data.my_queue = data.queue.findIndex(q => q.requested_by == data.me)+1;
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>aaron.brunet</sys_created_by>
        <sys_created_on>2024-03-07 01:15:14</sys_created_on>
        <sys_id>2996e3958774c2106e4b11f83cbb35ec</sys_id>
        <sys_mod_count>150</sys_mod_count>
        <sys_name>Charger Queue</sys_name>
        <sys_package display_value="Charger" source="x_snc_charger">7a4ce69387e04a106e4b11f83cbb3517</sys_package>
        <sys_policy/>
        <sys_scope display_value="Charger">7a4ce69387e04a106e4b11f83cbb3517</sys_scope>
        <sys_update_name>sp_widget_2996e3958774c2106e4b11f83cbb35ec</sys_update_name>
        <sys_updated_by>aaron.brunet</sys_updated_by>
        <sys_updated_on>2024-04-05 16:22:56</sys_updated_on>
        <template><![CDATA[<div class="charge-queue-container column charger-widget" ng-if="c.data.charge_session.details.state.value != 'in_progress'">
  <!-- REMOVED PENDING API ACCESS
  <div ng-if="!c.data.charge_session.details.active.value && data.available_chargers_count > 0">
    <div class="charge-queue-title column">
    	<h2>Available Chargers</h2>
    	<h4>{{data.available_chargers_count}} charger{{data.available_chargers_count != 1 ? 's' : ''}} available</h4>
    </div>
    <div>
      <sp-widget widget="data.widget"></sp-widget>
    </div>
  </div>
  -->
  <div ng-if="(!data.available_chargers_count || data.available_chargers_count == 0 || data.queue_length > 0) && (c.data.charge_session.details.state.value=='requested' || !data.my_request)">
    <div class="charge-queue-title column">
      <div class="">
          <h2 ng-if="!data.my_request">Join the Queue</h2>
          <h2 ng-if="data.my_request">You've Joined the Queue</h2>
       	  <h4 ng-if="data.queue_length"><i class="fa-solid fa-user"></i>{{data.queue_length}}</h4>
          <h4>There {{data.queue_length == 1 ? 'is' : 'are'}} {{data.queue_length || '0'}} currently waiting.</h4>
        	<h4 ng-if="data.my_request">You are #{{data.my_queue || '0'}} in queue.</h4>
        <p ng-if="!data.queue_length || data.queue_length == 0">Looks like you're first in line!</p>
      </div>
    </div>
    
     <div class="charge-queue-details column">
      <!-- REMOVED PENDING API ACCESS 
		<p ng-if="!data.available_chargers">Sorry, all chargers are currently full.</p>
	-->
      <button ng-if="!data.my_request" class="btn btn-primary" ng-click="c.action('join')">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 48 48" height="48" width="48" id="Flash-1--Streamline-Plump"><desc>Flash 1 Streamline Icon: https://streamlinehq.com</desc><g id="flash-1--flash-power-connect-charge-electricity-lightning"><path id="Union" fill="#1aeaac" d="M31.0468 0.731C27.2447 0.5129 20.7577 0.2866 14.362 0.7538C12.2385 0.9095 10.3976 2.2818 9.6421 4.2725C6.4172 12.7488 4.8806 20.5669 4.2255 24.7095C3.8154 27.3083 5.7039 29.6257 8.3017 29.8032C10.5215 29.9559 13.7826 30.1147 17.5889 30.094C17.184 33.3884 16.7614 37.7843 16.3409 42.5126C15.9661 46.7487 21.0598 49.2955 24.0915 46.0468C31.8753 37.7065 39.0113 28.4317 42.9235 23.1459C45.0768 20.2388 43.1809 16.1709 39.5045 16.0754C37.4318 16.0233 35.3585 16.007 33.2853 16.0266C34.009 12.8724 34.6631 9.4451 35.2642 6.1372C35.7522 3.4512 33.8283 0.8908 31.0468 0.731Z" stroke-width="1"></path></g></svg> 
        Join the Queue</button>
       
       <button ng-if="!data.my_request" class="btn btn-ghost" ng-click="c.action('join')">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 48 48" height="48" width="48" id="Flash-1--Streamline-Plump"><desc>Flash 1 Streamline Icon: https://streamlinehq.com</desc><g id="flash-1--flash-power-connect-charge-electricity-lightning"><path id="Union" fill="#1aeaac" d="M31.0468 0.731C27.2447 0.5129 20.7577 0.2866 14.362 0.7538C12.2385 0.9095 10.3976 2.2818 9.6421 4.2725C6.4172 12.7488 4.8806 20.5669 4.2255 24.7095C3.8154 27.3083 5.7039 29.6257 8.3017 29.8032C10.5215 29.9559 13.7826 30.1147 17.5889 30.094C17.184 33.3884 16.7614 37.7843 16.3409 42.5126C15.9661 46.7487 21.0598 49.2955 24.0915 46.0468C31.8753 37.7065 39.0113 28.4317 42.9235 23.1459C45.0768 20.2388 43.1809 16.1709 39.5045 16.0754C37.4318 16.0233 35.3585 16.007 33.2853 16.0266C34.009 12.8724 34.6631 9.4451 35.2642 6.1372C35.7522 3.4512 33.8283 0.8908 31.0468 0.731Z" stroke-width="1"></path></g></svg> 
        Join the Queue</button>
       
       <button ng-if="!data.my_request" class="btn btn-ghost btn-secondary" ng-click="c.action('join')">
		<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14" id="Wireless-Fast-Charging--Streamline-Flex"><desc>Wireless Fast Charging Streamline Icon: https://streamlinehq.com</desc><g id="wireless-fast-charging--wireless-fast-charging-flash-power-electricity-charge"><path id="Union" fill="#2859c5" fill-rule="evenodd" d="M7.977 4.234c0 -0.62 -0.728 -0.991 -1.21 -0.545 -0.903 0.837 -1.655 1.74 -2.379 2.734 -0.362 0.496 0.003 1.175 0.604 1.175h0.975v1.897c0 0.619 0.727 0.99 1.209 0.545 0.903 -0.838 1.655 -1.742 2.38 -2.734 0.361 -0.496 -0.003 -1.175 -0.605 -1.175h-0.974V4.234Z" clip-rule="evenodd" stroke-width="1"></path><path id="Union_2" fill="#1aeaac" fill-rule="evenodd" d="M7.02 2.473c1.472 0 2.528 0.402 3.223 1.068a0.75 0.75 0 0 0 1.037 -1.084C10.232 1.453 8.76 0.973 7.02 0.973c-1.784 0 -3.283 0.504 -4.335 1.556C1.678 3.536 1.174 4.95 1.13 6.632a5.989 5.989 0 0 1 -0.203 -0.044 0.747 0.747 0 0 0 -0.723 0.223 0.697 0.697 0 0 0 -0.102 0.802c0.36 0.68 0.933 1.15 1.686 1.406a0.49 0.49 0 0 0 0.297 0.006 0.761 0.761 0 0 0 0.365 -0.14 2.836 2.836 0 0 0 1.353 -1.248 0.698 0.698 0 0 0 -0.092 -0.803 0.747 0.747 0 0 0 -0.72 -0.233c-0.11 0.024 -0.232 0.048 -0.361 0.068 0.035 -1.405 0.45 -2.414 1.114 -3.079 0.696 -0.696 1.767 -1.117 3.275 -1.117Zm4.39 4.529a5.761 5.761 0 0 0 -0.449 0.086 0.747 0.747 0 0 1 -0.723 -0.223 0.697 0.697 0 0 1 -0.102 -0.802c0.36 -0.68 0.934 -1.15 1.687 -1.406a0.49 0.49 0 0 1 0.31 -0.002c0.756 0.247 1.335 0.709 1.704 1.384a0.697 0.697 0 0 1 -0.092 0.803 0.747 0.747 0 0 1 -0.72 0.233 6.021 6.021 0 0 0 -0.116 -0.024c-0.034 1.701 -0.539 3.132 -1.555 4.148 -1.052 1.053 -2.551 1.556 -4.334 1.556 -1.789 0 -3.292 -0.507 -4.344 -1.565a0.75 0.75 0 1 1 1.063 -1.058c0.696 0.7 1.77 1.123 3.28 1.123 1.508 0 2.58 -0.421 3.275 -1.117 0.674 -0.674 1.09 -1.701 1.116 -3.136Z" clip-rule="evenodd" stroke-width="1"></path></g></svg>
      Join the Queue</button>
       <button ng-if="data.my_request" class="btn btn-option" ng-click="c.action('update')"><i class="fa-solid fa-plug-circle-exclamation"></i> Update My Request</button>
    </div>
  </div>
  
</div>]]></template>
    </sp_widget>
</record_update>
